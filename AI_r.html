<body>

    <style>
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .spacer {
            height: 15px;
        }
        
        textarea {
            width: 700px;
            height: 180px;
            resize: none;
            border-radius: 8px;
        }
        
         ::-webkit-input-placeholder {
            line-height: 170px;
            text-align: center;
            color: #0000ff;
        }
        
        button {
            font-weight: bold;
            height: 4vh;
            background-color: #00ffff;
            color: #000000;
            border: none;
            border-radius: 8px;
        }
        
        #textInput::placeholder {
            font-weight: bold;
        }
        
        #textOutput::placeholder {
            font-weight: bold;
        }
    </style>
    <div class="container">
        Învățăm limba română!
        <div class=" spacer"></div>
        <textarea id="textInput" placeholder="Aici veți vedea textul rostit de Dumneavoastră"></textarea>
        <div class=" spacer"></div>
        <button id="sendButton" onclick="speech()">Doriți să spuneți ceva? Apăsați aici - și vorbiți</button>
        <div class=" spacer"></div>
        <textarea id="textOutput" placeholder="Aici veți vedea răspunsul pronunțat de Inteligența Artificială (IA)"></textarea>
        <div class=" spacer"></div>
        <button onclick="talk(outp.value)">Doriți să ascultați încă o dată răspunsul pronunțat de IA - apăsați aici</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        let apiKey = 'sk-proj-XKB2ACw3ImhbSEervL96T3BlbkFJXu2zrbkZFM5kQ88hbki8';
        // let apiKey = 'sk-proj-TQA2rzfkgMhrnTTznFxWT3BlbkFJ4IZqmLMKtXNHGlK6ZjJG';

        let sendButton = window.document.getElementById('sendButton');

        let inp = window.document.getElementById('textInput');

        let outp = window.document.getElementById('textOutput');

        let conversation = [];

        let speechRecognizer = new webkitSpeechRecognition();        // recunoaștere voce

        let speechSynthesis = window.speechSynthesis;                // sinteză voce

        const speech = () => {
            speechRecognizer.lang = 'ro-RO';
            // speechRecognizer.continuous = true;
            // speechRecognizer.interimResults = true;
            speechRecognizer.start();
            sendButton.innerText = 'Vorbiți...';
        }

        const talk = (text) => {
            let textToTalk = new SpeechSynthesisUtterance(text);
            textToTalk.onend = function(event) {
                sendButton.innerText = 'Doriți să mai spuneți ceva? Apăsați aici - și vorbiți';
            };
            textToTalk.lang = 'ro-RO';
            textToTalk.rate = 0.5;
            // textToTalk.pitch = 1.0;
            speechSynthesis.speak(textToTalk);
        }

        let request = axios.create({                                 // integrare Chat GPT
            headers: {
                Authorization: `Bearer ${apiKey}`
            }
        })

        speechRecognizer.onresult = (event) => {                    
            inp.value = event.results[0][0].transcript;
            requestFunc();
        }

        const requestFunc = () => {
            if (inp.value) {
                sendButton.innerText = 'O clipă...';
                let message = {
                    "role": "user",
                    "content": `${inp.value}`
                }
                conversation.push(message);
                let params = {
                    "model": "gpt-3.5-turbo",
                    "messages": conversation
                };
                request.post('https://api.openai.com/v1/chat/completions', params)
                    .then(response => {
                        outp.value = response.data.choices[0].message.content;
                        let gptMessage = {
                            "role": "assistant",
                            "content": `${outp.value}`
                        }
                        conversation.push(gptMessage);
                        talk(outp.value);
                    })
                    // .catch(error => {
                    //    console.error("Eroare la executarea cererii:", error);
                    // });
            }
        }
    </script>
</body>